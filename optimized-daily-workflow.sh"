#!/bin/bash

# TradeFlow æ—¥å¸¸é‹ç”¨æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ¯æ—¥ã®ä½œæ¥­ã‚µã‚¤ã‚¯ãƒ«ã‚’è‡ªå‹•åŒ–

set -e

# è‰²ä»˜ããƒ­ã‚°
log_info() { echo -e "\\033[1;36m[INFO]\\033[0m $1"; }
log_success() { echo -e "\\033[1;32m[SUCCESS]\\033[0m $1"; }
log_warning() { echo -e "\\033[1;33m[WARNING]\\033[0m $1"; }
log_error() { echo -e "\\033[1;31m[ERROR]\\033[0m $1"; }

PROJECT_ROOT="/Users/yono/Build/TradeFlow"
CLAUDE_DIR="$PROJECT_ROOT/scripts/Claude-Code-Communication"
TASK_STATE_FILE="$CLAUDE_DIR/.task_state.json"
LOG_DIR="$HOME/ObsidianVault/claude_logs"

echo "ğŸš€ TradeFlow æ—¥å¸¸é‹ç”¨é–‹å§‹"
echo "========================="
echo ""

# ã‚·ã‚¹ãƒ†ãƒ è² è·ãƒã‚§ãƒƒã‚¯
check_system_load() {
    local cpu_usage=$(top -l 1 -n 0 | grep "CPU usage" | awk '{print $3}' | sed 's/%//')
    local memory_pressure=$(memory_pressure | grep "System-wide memory free percentage" | awk '{print $5}' | sed 's/%//')
    
    log_info "ğŸ’» ã‚·ã‚¹ãƒ†ãƒ è² è·ãƒã‚§ãƒƒã‚¯"
    echo "  CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    echo "  ãƒ¡ãƒ¢ãƒªç©ºã: ${memory_pressure}%"
    
    # CPUä½¿ç”¨ç‡ãŒ70%ä»¥ä¸Šã®å ´åˆã¯è»½é‡ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶
    if (( $(echo "$cpu_usage > 70" | bc -l) )); then
        log_warning "âš ï¸  é«˜è² è·æ¤œå‡º - è»½é‡ãƒ¢ãƒ¼ãƒ‰ã‚’é©ç”¨"
        export LIGHTWEIGHT_MODE=true
    else
        export LIGHTWEIGHT_MODE=false
    fi
}

# æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleanup_sessions() {
    log_info "ğŸ§¹ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    
    # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«çµ‚äº†
    tmux kill-session -t tradeflow 2>/dev/null || true
    tmux kill-session -t president 2>/dev/null || true
    tmux kill-session -t multiagent 2>/dev/null || true
    
    # ãƒ—ãƒ­ã‚»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    pkill -f "claude.*dangerously" 2>/dev/null || true
    sleep 2
    
    log_success "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
}

# æœ€é©åŒ–ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
create_optimized_sessions() {
    log_info "ğŸ“º æœ€é©åŒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ"
    
    # ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆpresidentç”¨ï¼‰
    tmux new-session -d -s president -n main -c "$CLAUDE_DIR"
    
    # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆ6ãƒšã‚¤ãƒ³æ§‹æˆï¼‰
    tmux new-session -d -s multiagent -n main -c "$CLAUDE_DIR"
    
    # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒšã‚¤ãƒ³åˆ†å‰²
    tmux split-window -t multiagent:main -h
    tmux split-window -t multiagent:main.0 -v
    tmux split-window -t multiagent:main.2 -v
    tmux split-window -t multiagent:main.1 -v
    tmux split-window -t multiagent:main.4 -v
    
    # ãƒšã‚¤ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´
    tmux select-layout -t multiagent:main tiled
    
    log_success "âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†"
}

# Claudeèµ·å‹•ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
start_claude_optimized() {
    log_info "ğŸ¤– Claudeèµ·å‹•ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
    SESSION_ID=$(date +%Y%m%d_%H%M%S)
    
    # Obsidianãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
    mkdir -p "$LOG_DIR"
    
    # å¤ã„ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ7æ—¥ä»¥ä¸Šï¼‰
    find "$LOG_DIR" -name "*.md" -mtime +7 -delete 2>/dev/null || true
    
    # Presidentç”¨Claudeèµ·å‹•
    log_info "  Presidentèµ·å‹•ä¸­..."
    tmux send-keys -t president:main "claude --dangerously-skip-permissions 2>&1 | tee $LOG_DIR/president_${SESSION_ID}.md" C-m
    
    # MultiAgentç”¨Claudeèµ·å‹•
    log_info "  MultiAgentèµ·å‹•ä¸­..."
    ENGINEERS=("analysis_engineer" "data_engineer" "trading_engineer" "risk_engineer" "tech_lead" "monitoring")
    
    for i in "${!ENGINEERS[@]}"; do
        engineer="${ENGINEERS[$i]}"
        log_file="$LOG_DIR/${engineer}_${SESSION_ID}.md"
        tmux send-keys -t "multiagent:main.$i" "claude --dangerously-skip-permissions 2>&1 | tee $log_file" C-m
        sleep 1
    done
    
    log_success "âœ… Claudeèµ·å‹•å®Œäº†"
}

# Alacrittyèµ·å‹•ï¼ˆä¿®æ­£ç‰ˆï¼‰
start_alacritty_optimized() {
    log_info "ğŸ–¥ï¸ Alacrittyèµ·å‹•ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰"
    
    # Presidentç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
    alacritty --working-directory "$CLAUDE_DIR" \
              --title "TradeFlow-President" \
              --command tmux attach-session -t president &
    
    sleep 2
    
    # MultiAgentç›£è¦–ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if [ "$LIGHTWEIGHT_MODE" != "true" ]; then
        alacritty --working-directory "$CLAUDE_DIR" \
                  --title "TradeFlow-MultiAgent" \
                  --command tmux attach-session -t multiagent &
    fi
    
    log_success "âœ… Alacrittyèµ·å‹•å®Œäº†"
}

# ã‚¿ã‚¹ã‚¯çŠ¶æ…‹åˆæœŸåŒ–
initialize_task_state() {
    log_info "ğŸ“‹ ã‚¿ã‚¹ã‚¯çŠ¶æ…‹åˆæœŸåŒ–"
    
    cat > "$TASK_STATE_FILE" << EOF
{
  "current_session": {
    "id": "$(date +%Y%m%d_%H%M%S)",
    "start_time": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
    "active_engineer": "president",
    "current_task": "daily_startup",
    "progress": 0,
    "lightweight_mode": $LIGHTWEIGHT_MODE
  },
  "tasks": [],
  "checkpoints": [],
  "issue_tracker": {
    "enabled": true,
    "auto_create": true,
    "auto_update": true
  },
  "daily_cycle": {
    "cycle_count": 1,
    "last_restart": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
    "auto_restart_enabled": true
  }
}
EOF
    
    log_success "âœ… ã‚¿ã‚¹ã‚¯çŠ¶æ…‹åˆæœŸåŒ–å®Œäº†"
}

# è‡ªå‹•å†èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ 
setup_auto_restart() {
    log_info "ğŸ”„ è‡ªå‹•å†èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ è¨­å®š"
    
    # è‡ªå‹•å†èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
    cat > "$CLAUDE_DIR/auto-restart-cycle.sh" << 'EOF'
#!/bin/bash

# TradeFlowè‡ªå‹•å†èµ·å‹•ã‚µã‚¤ã‚¯ãƒ«
# ä½œæ¥­å®Œäº†å¾Œã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼†å†èµ·å‹•

CLAUDE_DIR="/Users/yono/Build/TradeFlow/scripts/Claude-Code-Communication"
TASK_STATE_FILE="$CLAUDE_DIR/.task_state.json"

# ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
check_task_completion() {
    if [ -f "$TASK_STATE_FILE" ]; then
        local progress=$(cat "$TASK_STATE_FILE" | jq -r '.current_session.progress // 0')
        if [ "$progress" -eq 100 ]; then
            return 0  # å®Œäº†
        fi
    fi
    return 1  # æœªå®Œäº†
}

# è‡ªå‹•å†èµ·å‹•å®Ÿè¡Œ
if check_task_completion; then
    echo "ğŸ‰ ã‚¿ã‚¹ã‚¯å®Œäº†æ¤œå‡º - è‡ªå‹•å†èµ·å‹•é–‹å§‹"
    
    # 5ç§’å¾…æ©Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµæœã‚’ç¢ºèªã™ã‚‹æ™‚é–“ï¼‰
    sleep 5
    
    # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
    tmux kill-session -t president 2>/dev/null || true
    tmux kill-session -t multiagent 2>/dev/null || true
    
    # æ–°ã—ã„ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹
    "$CLAUDE_DIR/optimized-daily-workflow.sh"
else
    echo "â³ ã‚¿ã‚¹ã‚¯é€²è¡Œä¸­ - å†èµ·å‹•ã‚’ã‚¹ã‚­ãƒƒãƒ—"
fi
EOF
    
    chmod +x "$CLAUDE_DIR/auto-restart-cycle.sh"
    
    log_success "âœ… è‡ªå‹•å†èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå®Œäº†"
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    # 1. ã‚·ã‚¹ãƒ†ãƒ è² è·ãƒã‚§ãƒƒã‚¯
    check_system_load
    
    # 2. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cleanup_sessions
    
    # 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    create_optimized_sessions
    
    # 4. Claudeèµ·å‹•
    start_claude_optimized
    
    # 5. Alacrittyèµ·å‹•
    start_alacritty_optimized
    
    # 6. ã‚¿ã‚¹ã‚¯çŠ¶æ…‹åˆæœŸåŒ–
    initialize_task_state
    
    # 7. è‡ªå‹•å†èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ 
    setup_auto_restart
    
    echo ""
    echo "ğŸ¯ æ—¥å¸¸é‹ç”¨é–‹å§‹å®Œäº†ï¼"
    echo "====================="
    echo ""
    echo "ğŸ“‹ ä½¿ç”¨æ–¹æ³•:"
    echo "  1. Presidentç”»é¢ã§æŒ‡ä»¤ã‚’å‡ºã™"
    echo "  2. MultiAgentç”»é¢ã§ä½œæ¥­çŠ¶æ³ã‚’ç›£è¦–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
    echo "  3. ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã¯è‡ªå‹•çš„ã«å†èµ·å‹•ã‚µã‚¤ã‚¯ãƒ«ãŒé–‹å§‹"
    echo ""
    echo "âš¡ ä¾¿åˆ©ã‚³ãƒãƒ³ãƒ‰:"
    echo "  tf-status          # ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ç¢ºèª"
    echo "  tf-update-progress # é€²æ—æ›´æ–°"
    echo "  tf-restart-cycle   # æ‰‹å‹•å†èµ·å‹•"
    echo "  tf-load            # ã‚·ã‚¹ãƒ†ãƒ è² è·ç¢ºèª"
    echo ""
    echo "ğŸ’¡ ã‚·ã‚¹ãƒ†ãƒ è² è·: $([ "$LIGHTWEIGHT_MODE" = "true" ] && echo "è»½é‡ãƒ¢ãƒ¼ãƒ‰" || echo "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰")"
    echo ""
    echo "ğŸƒ Presidentç”»é¢ã§ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼"
}

# å®Ÿè¡Œ
main "$@" 